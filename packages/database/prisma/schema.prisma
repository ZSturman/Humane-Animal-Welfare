// ============================================================================
// SHELTER LINK - Prototype Data Model (SQLite)
// ============================================================================
// Simplified schema for local development prototype.
// For full production schema, see: _archive/prisma/schema.full.prisma
//
// Changes from production:
// - Provider: sqlite (was postgresql)
// - Reduced from 35+ models to 10 essential models
// - Removed: Sessions, ApiKeys, Microchips, MedicalRecords, Vaccinations,
//           BehavioralAssessments, AnimalNotes, AnimalEvents, AuditLogs,
//           Notifications, SavedSearches, Webhooks, ImportJobs
// - Simplified JSON handling (stored as strings)
// - Uses uuid() instead of gen_random_uuid()
//
// TODO: Production - Migrate to PostgreSQL, restore full schema from _archive/prisma/schema.full.prisma
// ============================================================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// ============================================================================
// ORGANIZATION & ACCESS CONTROL
// ============================================================================

/// Represents a shelter, rescue, or animal welfare organization
model Organization {
  id          String   @id @default(uuid())
  name        String
  slug        String   @unique
  type        String   @default("PRIVATE_SHELTER") // OrganizationType enum as string
  status      String   @default("ACTIVE") // OrganizationStatus enum as string
  
  // Location info (simplified - no separate Location model)
  address     String?  // JSON string: { street, city, state, zip, country }
  city        String?  // Denormalized for search
  state       String?  // Denormalized for search
  zipCode     String?  // Denormalized for search
  latitude    Float?
  longitude   Float?
  
  // Contact
  phone       String?
  email       String?
  website     String?
  
  // Capacity (simplified)
  capacity    Int      @default(100)
  
  // Relations
  animals     Animal[]
  users       UserOrganization[]
  transfersFrom TransferRequest[] @relation("TransferFrom")
  transfersTo   TransferRequest[] @relation("TransferTo")
  joinRequests  JoinRequest[]
  intakeEvents  IntakeEvent[]
  outcomeEvents OutcomeEvent[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([slug])
  @@index([city])
  @@index([state])
  @@map("organizations")
}

/// User accounts
model User {
  id           String   @id @default(uuid())
  email        String   @unique
  passwordHash String
  name         String
  phone        String?
  avatarUrl    String?
  
  // Role for users not in an organization (SUPERADMIN, PUBLIC)
  globalRole   String   @default("PUBLIC")
  
  status       String   @default("ACTIVE") // UserStatus enum as string
  lastLoginAt  DateTime?
  
  // Relations
  organizations UserOrganization[]
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  @@index([email])
  @@map("users")
}

/// Junction table for users and organizations with role-based access
model UserOrganization {
  id             String       @id @default(uuid())
  userId         String
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  role           String       @default("STAFF") // UserRole enum as string
  isPrimary      Boolean      @default(false)
  
  joinedAt       DateTime     @default(now())
  
  @@unique([userId, organizationId])
  @@index([organizationId])
  @@map("user_organizations")
}

// ============================================================================
// CORE ANIMAL MODEL
// ============================================================================

/// Central animal record
model Animal {
  id             String   @id @default(uuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])
  
  // Identity
  name           String
  species        String   // Species enum as string
  breedPrimary   String?
  breedSecondary String?
  
  // Physical
  sex            String   @default("UNKNOWN") // Sex enum as string
  alteredStatus  String   @default("UNKNOWN") // AlteredStatus enum as string
  colorPrimary   String?
  colorSecondary String?
  coatType       String?
  weightKg       Float?
  size           String?  // SizeCategory enum as string
  
  // Age
  birthDate      DateTime?
  ageCategory    String?  // AgeCategory enum as string
  
  // Status
  status         String   @default("IN_SHELTER") // AnimalStatus enum as string
  kennelNumber   String?
  isPublic       Boolean  @default(true)
  isFeatured     Boolean  @default(false)
  
  // Descriptions
  description    String?  // Public description
  staffNotes     String?  // Internal notes (hidden from public)
  specialNeeds   String?
  intakeNotes    String?
  
  // Characteristics (stored as JSON string)
  characteristics String? // JSON array of tags
  goodWithChildren Boolean?
  goodWithDogs     Boolean?
  goodWithCats     Boolean?
  houseTrained     Boolean?
  
  // Intake/Outcome
  intakeDate     DateTime @default(now())
  outcomeDate    DateTime?
  daysInShelter  Int      @default(0)
  
  // Adoption
  adoptionFee    Int?     // In cents
  
  // Internal ID
  internalId     String?
  
  // Relations
  riskProfile    RiskProfile?
  photos         AnimalPhoto[]
  intakeEvents   IntakeEvent[]
  outcomeEvents  OutcomeEvent[]
  transferRequests TransferRequest[]
  
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  
  @@index([organizationId, status])
  @@index([species, status])
  @@index([intakeDate])
  @@index([isPublic, status])
  @@map("animals")
}

// ============================================================================
// RISK PROFILE
// ============================================================================

/// Simplified risk assessment for prioritizing vulnerable animals
model RiskProfile {
  id           String @id @default(uuid())
  animalId     String @unique
  animal       Animal @relation(fields: [animalId], references: [id], onDelete: Cascade)
  
  // Core risk metrics
  urgencyScore Int    @default(0)  // 0-100
  riskSeverity String @default("LOW") // RiskSeverity enum as string
  riskReasons  String @default("[]") // JSON array of reason strings
  
  // Factors
  lengthOfStay Int    @default(0)
  isSenior     Boolean @default(false)
  hasSpecialNeeds Boolean @default(false)
  
  // Metadata
  lastCalculated DateTime @default(now())
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  @@index([urgencyScore])
  @@index([riskSeverity])
  @@map("risk_profiles")
}

// ============================================================================
// ANIMAL PHOTOS
// ============================================================================

/// Photo/media for animals
model AnimalPhoto {
  id          String  @id @default(uuid())
  animalId    String
  animal      Animal  @relation(fields: [animalId], references: [id], onDelete: Cascade)
  
  filename    String
  filepath    String  // Local path: uploads/{animalId}/{filename}
  mimetype    String  @default("image/jpeg")
  size        Int     @default(0) // File size in bytes
  
  label       String? // User-defined label (e.g., "Intake photo", "Post-surgery")
  isThumbnail Boolean @default(false)
  isPublic    Boolean @default(true)
  sortOrder   Int     @default(0)
  
  createdAt   DateTime @default(now())
  
  @@index([animalId])
  @@map("animal_photos")
}

// ============================================================================
// INTAKE & OUTCOME EVENTS
// ============================================================================

/// Intake event (simplified)
model IntakeEvent {
  id             String       @id @default(uuid())
  animalId       String
  animal         Animal       @relation(fields: [animalId], references: [id], onDelete: Cascade)
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])
  
  intakeType     String       // IntakeType enum as string
  intakeDate     DateTime     @default(now())
  condition      String       @default("HEALTHY") // IntakeCondition enum as string
  
  foundLocation  String?
  notes          String?
  processedBy    String?      // User name who processed
  
  createdAt      DateTime     @default(now())
  
  @@index([animalId])
  @@index([organizationId])
  @@map("intake_events")
}

/// Outcome event (simplified)
model OutcomeEvent {
  id             String       @id @default(uuid())
  animalId       String
  animal         Animal       @relation(fields: [animalId], references: [id], onDelete: Cascade)
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])
  
  outcomeType    String       // OutcomeType enum as string
  outcomeDate    DateTime     @default(now())
  
  // For adoptions - minimal info
  adopterName    String?
  adopterEmail   String?
  
  // For transfers
  destinationOrgId   String?
  destinationOrgName String?
  
  // For euthanasia - humane handling
  euthanasiaReason   String?
  memorialNote       String?  // Optional memorial message
  
  notes          String?
  processedBy    String?
  
  createdAt      DateTime     @default(now())
  
  @@index([animalId])
  @@index([organizationId])
  @@map("outcome_events")
}

// ============================================================================
// TRANSFERS
// ============================================================================

/// Transfer request between organizations
model TransferRequest {
  id               String       @id @default(uuid())
  animalId         String
  animal           Animal       @relation(fields: [animalId], references: [id], onDelete: Cascade)
  
  fromOrganizationId String
  fromOrganization   Organization @relation("TransferFrom", fields: [fromOrganizationId], references: [id])
  
  toOrganizationId   String
  toOrganization     Organization @relation("TransferTo", fields: [toOrganizationId], references: [id])
  
  status           String       @default("PENDING") // TransferStatus enum as string
  urgency          String       @default("NORMAL")  // HIGH, NORMAL, LOW
  
  reason           String?
  notes            String?
  
  requestedById    String?
  requestedByName  String?
  
  respondedAt      DateTime?
  respondedById    String?
  responseNotes    String?
  
  scheduledDate    DateTime?
  completedAt      DateTime?
  
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt
  
  @@index([fromOrganizationId])
  @@index([toOrganizationId])
  @@index([status])
  @@map("transfer_requests")
}

// ============================================================================
// JOIN REQUESTS (For shelters wanting to join ShelterLink)
// ============================================================================

/// Request from a shelter to join the platform
model JoinRequest {
  id              String   @id @default(uuid())
  
  // Organization info (before they have an org record)
  organizationName String
  organizationType String   @default("PRIVATE_SHELTER")
  
  // Contact info
  contactName     String
  contactEmail    String
  contactPhone    String?
  
  // Location
  address         String?
  city            String?
  state           String?
  zipCode         String?
  
  website         String?
  
  // Request details
  message         String?  // Why they want to join
  estimatedAnimals Int?    // Approximate number of animals
  
  status          String   @default("PENDING") // PENDING, APPROVED, REJECTED
  
  // If approved, link to created organization
  organizationId  String?
  organization    Organization? @relation(fields: [organizationId], references: [id])
  
  // Processing
  reviewedAt      DateTime?
  reviewedBy      String?
  reviewNotes     String?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([status])
  @@map("join_requests")
}

// ============================================================================
// ENUM REFERENCE (Stored as strings in SQLite)
// ============================================================================
// 
// OrganizationType: MUNICIPAL_SHELTER, PRIVATE_SHELTER, RESCUE, SANCTUARY, FOSTER_NETWORK
// OrganizationStatus: ACTIVE, SUSPENDED, INACTIVE, PENDING_VERIFICATION
// UserStatus: ACTIVE, SUSPENDED, DEACTIVATED
// UserRole: OWNER, ADMIN, MANAGER, STAFF, VOLUNTEER, FOSTER, READ_ONLY
// GlobalRole: SUPERADMIN, PUBLIC
// Species: DOG, CAT, RABBIT, GUINEA_PIG, HAMSTER, BIRD, REPTILE, FERRET, HORSE, OTHER
// Sex: MALE, FEMALE, UNKNOWN
// AlteredStatus: YES, NO, UNKNOWN, PENDING
// SizeCategory: TINY, SMALL, MEDIUM, LARGE, EXTRA_LARGE
// AgeCategory: BABY, YOUNG, ADULT, SENIOR, GERIATRIC
// AnimalStatus: IN_SHELTER, IN_FOSTER, IN_MEDICAL, AVAILABLE, PENDING, ADOPTED, TRANSFERRED, EUTHANIZED, DECEASED
// RiskSeverity: CRITICAL, HIGH, ELEVATED, MODERATE, LOW
// IntakeType: STRAY, OWNER_SURRENDER, TRANSFER_IN, RETURN, BORN_IN_CARE, OTHER
// IntakeCondition: HEALTHY, TREATABLE_MINOR, TREATABLE_MAJOR, UNKNOWN
// OutcomeType: ADOPTION, TRANSFER_OUT, RETURN_TO_OWNER, EUTHANASIA, DIED_IN_CARE, FOSTER
// TransferStatus: PENDING, APPROVED, SCHEDULED, IN_TRANSIT, COMPLETED, DECLINED, CANCELLED
